<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Prosper Meal Plan</title>
    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --accent: #6e56cf; /* Prosper Purple */
            --accent-dim: #2f265f;
            --text: #ffffff;
            --text-sec: #8e8e93;
            --border: #2c2c2e;
            --success: #32d74b;
            --danger: #ff453a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 90px; /* Space for dock */
            -webkit-user-select: none;
            user-select: none;
        }

        /* --- DASHBOARD HEADER --- */
        .dashboard {
            padding: 50px 20px 20px 20px;
            background: linear-gradient(180deg, rgba(30,30,30,1) 0%, rgba(0,0,0,0) 100%);
        }
        .date-header { font-size: 32px; font-weight: 800; margin-bottom: 5px; }
        .subtitle { color: var(--text-sec); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        .stats-row {
            display: flex; gap: 10px; margin-top: 20px;
        }
        .stat-card {
            flex: 1; background: var(--card); border-radius: 12px; padding: 12px;
            text-align: center; border: 1px solid var(--border);
        }
        .stat-val { font-size: 18px; font-weight: 700; display: block; }
        .stat-label { font-size: 11px; color: var(--text-sec); text-transform: uppercase; }

        /* --- TIMELINE VIEW --- */
        .timeline-container { padding: 10px 20px; position: relative; }
        
        /* The vertical line */
        .timeline-container::before {
            content: ''; position: absolute; left: 35px; top: 0; bottom: 0;
            width: 2px; background: var(--border); z-index: 0;
        }

        .time-slot {
            display: flex; align-items: flex-start; margin-bottom: 25px; position: relative; z-index: 1;
        }
        
        .time-label {
            width: 40px; font-size: 12px; color: var(--text-sec); font-weight: 600; padding-top: 15px; background: var(--bg);
        }

        .meal-card {
            flex: 1; margin-left: 15px;
            background: var(--card); border-radius: 16px; padding: 15px;
            border: 1px solid var(--border);
            position: relative; transition: transform 0.1s;
        }
        .meal-card:active { transform: scale(0.98); }

        .meal-card.empty {
            border: 1px dashed var(--border); background: transparent; color: var(--text-sec);
            display: flex; align-items: center; justify-content: center; height: 50px;
        }

        .meal-title { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .meal-info { font-size: 13px; color: var(--text-sec); }
        .meal-macros { font-size: 11px; color: var(--accent); margin-top: 8px; font-weight: 600; }

        /* --- BOTTOM NAVIGATION (DOCK) --- */
        .dock {
            position: fixed; bottom: 20px; left: 20px; right: 20px;
            background: rgba(28, 28, 30, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 15px;
            display: flex; justify-content: space-around;
            border: 1px solid var(--border);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            z-index: 100;
        }
        .dock-btn {
            background: none; border: none; color: var(--text-sec);
            font-size: 24px; cursor: pointer; position: relative;
        }
        .dock-btn.active { color: var(--text); }
        .dock-btn.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 4px; height: 4px; background: var(--accent); border-radius: 50%;
        }

        /* --- MODALS (Drawers) --- */
        .drawer-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 200;
            display: none; align-items: flex-end;
        }
        .drawer {
            background: var(--card); width: 100%; border-radius: 24px 24px 0 0;
            padding: 25px; box-sizing: border-box;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 85vh; overflow-y: auto;
        }
        .drawer.open { transform: translateY(0); }

        /* Form Inputs */
        input, select {
            width: 100%; padding: 14px; margin-bottom: 12px;
            background: #2c2c2e; border: none; border-radius: 10px;
            color: white; font-size: 16px; box-sizing: border-box;
        }
        input:focus { outline: 2px solid var(--accent); }

        .btn-primary {
            width: 100%; background: var(--accent); color: white;
            padding: 16px; border-radius: 12px; border: none;
            font-weight: 700; font-size: 16px; margin-top: 10px;
        }
        
        /* Ingredient Row in Form */
        .ing-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .ing-unit { flex: 0.5; }

        /* Shopping List Style */
        .check-item {
            display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border);
        }
        .check-item input { width: 24px; height: 24px; margin-right: 15px; accent-color: var(--accent); }
        .check-item.done { opacity: 0.3; text-decoration: line-through; }
    </style>
</head>
<body>

    <div id="view-timeline">
        <div class="dashboard">
            <div class="subtitle">Today's Plan</div>
            <div class="date-header" id="currentDate">Monday</div>
            
            <div class="stats-row">
                <div class="stat-card">
                    <span class="stat-val" id="totalCal">0</span>
                    <span class="stat-label">Kcal</span>
                </div>
                <div class="stat-card">
                    <span class="stat-val" id="totalItems">0</span>
                    <span class="stat-label">Ingred.</span>
                </div>
            </div>
        </div>

        <div class="timeline-container" id="timeline">
            </div>
    </div>

    <div id="view-shopping" style="display:none; padding: 50px 20px;">
        <div class="date-header">Shopping List</div>
        <div class="subtitle" style="margin-bottom: 20px;">Based on your schedule</div>
        <div id="shoppingListContainer"></div>
    </div>

    <div id="view-recipes" style="display:none; padding: 50px 20px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div class="date-header">Recipes</div>
            <button onclick="openRecipeDrawer()" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:20px; font-weight:600;">+ New</button>
        </div>
        <div id="recipeListContainer" style="margin-top:20px;"></div>
    </div>

    <div class="dock">
        <button class="dock-btn active" onclick="switchView('timeline', this)">ðŸ“…</button>
        <button class="dock-btn" onclick="switchView('recipes', this)">ðŸ“–</button>
        <button class="dock-btn" onclick="switchView('shopping', this)">ðŸ›’</button>
    </div>

    <div id="drawer-select" class="drawer-overlay" onclick="closeDrawer('drawer-select')">
        <div class="drawer" onclick="event.stopPropagation()">
            <h2 style="margin-top:0">Add to <span id="selectedSlotTime"></span></h2>
            <div id="selectorList" style="display:grid; gap:10px;"></div>
            <button class="btn-primary" style="background:var(--card); border:1px solid var(--border); margin-top:10px" onclick="clearSlot()">Clear Slot</button>
        </div>
    </div>

    <div id="drawer-recipe" class="drawer-overlay" onclick="closeDrawer('drawer-recipe')">
        <div class="drawer" onclick="event.stopPropagation()">
            <h2 style="margin-top:0">Create Recipe</h2>
            <input type="text" id="newRecName" placeholder="Recipe Name (e.g., Avocado Toast)">
            <input type="number" id="newRecCal" placeholder="Calories (e.g., 350)">
            
            <label style="font-size:12px; color:var(--text-sec); text-transform:uppercase;">Ingredients</label>
            <div id="ingContainer"></div>
            <button onclick="addIngInput()" style="width:100%; padding:10px; background:#2c2c2e; border:none; color:white; border-radius:8px; margin-top:5px;">+ Add Ingredient</button>

            <button class="btn-primary" onclick="saveRecipe()">Save Recipe</button>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        let recipes = JSON.parse(localStorage.getItem('proRecipes')) || [];
        // Schedule: { "08:00": recipeIndex, "12:00": recipeIndex ... }
        let schedule = JSON.parse(localStorage.getItem('proSchedule')) || {};
        
        // Define the "Day" structure (Time Blocks)
        const timeBlocks = ["08:00", "10:00", "13:00", "16:00", "19:00"];
        let currentSlot = null;

        // --- INIT ---
        function init() {
            document.getElementById('currentDate').innerText = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            renderTimeline();
            updateDashboard();
        }

        // --- RENDER TIMELINE ---
        function renderTimeline() {
            const container = document.getElementById('timeline');
            container.innerHTML = "";

            timeBlocks.forEach(time => {
                const recIdx = schedule[time];
                const recipe = recipes[recIdx];

                let cardHtml = "";
                if (recipe) {
                    cardHtml = `
                        <div class="meal-card" onclick="openSelector('${time}')">
                            <div class="meal-title">${recipe.name}</div>
                            <div class="meal-info">${recipe.ings.length} ingredients</div>
                            <div class="meal-macros">${recipe.cal} kcal</div>
                        </div>
                    `;
                } else {
                    cardHtml = `
                        <div class="meal-card empty" onclick="openSelector('${time}')">
                            <span>+ Add Meal</span>
                        </div>
                    `;
                }

                container.innerHTML += `
                    <div class="time-slot">
                        <div class="time-label">${time}</div>
                        ${cardHtml}
                    </div>
                `;
            });
        }

        // --- DASHBOARD UPDATES ---
        function updateDashboard() {
            let totalCal = 0;
            let totalIng = 0;

            Object.values(schedule).forEach(idx => {
                const r = recipes[idx];
                if(r) {
                    totalCal += parseInt(r.cal) || 0;
                    totalIng += r.ings.length;
                }
            });

            // Animate numbers logic could go here, keeping it simple for now
            document.getElementById('totalCal').innerText = totalCal;
            document.getElementById('totalItems').innerText = totalIng;
        }

        // --- RECIPE MANAGEMENT ---
        function renderRecipes() {
            const container = document.getElementById('recipeListContainer');
            container.innerHTML = "";
            recipes.forEach((r, i) => {
                container.innerHTML += `
                    <div class="meal-card" style="margin-left:0; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div>
                            <div class="meal-title">${r.name}</div>
                            <div class="meal-macros">${r.cal} kcal</div>
                        </div>
                        <button onclick="deleteRecipe(${i})" style="background:none; border:none; color:var(--danger); font-size:18px;">âœ•</button>
                    </div>
                `;
            });
        }

        function saveRecipe() {
            const name = document.getElementById('newRecName').value;
            const cal = document.getElementById('newRecCal').value;
            const rows = document.querySelectorAll('.ing-row');
            let ings = [];

            rows.forEach(row => {
                const n = row.querySelector('.ing-n').value;
                const q = row.querySelector('.ing-q').value;
                const u = row.querySelector('.ing-u').value;
                if(n && q) ings.push({n, q: parseFloat(q), u});
            });

            if(!name) return alert("Name required");

            recipes.push({name, cal, ings});
            localStorage.setItem('proRecipes', JSON.stringify(recipes));
            closeDrawer('drawer-recipe');
            renderRecipes();
        }

        function deleteRecipe(i) {
            if(confirm("Delete?")) {
                recipes.splice(i, 1);
                // Clean up schedule
                for(let t in schedule) { if(schedule[t] == i) delete schedule[t]; }
                
                localStorage.setItem('proRecipes', JSON.stringify(recipes));
                localStorage.setItem('proSchedule', JSON.stringify(schedule));
                renderRecipes();
                renderTimeline();
                updateDashboard();
            }
        }

        // --- SELECTION LOGIC ---
        function openSelector(time) {
            currentSlot = time;
            document.getElementById('selectedSlotTime').innerText = time;
            const list = document.getElementById('selectorList');
            list.innerHTML = "";
            
            recipes.forEach((r, i) => {
                list.innerHTML += `
                    <div class="meal-card" style="margin:0; cursor:pointer;" onclick="selectRecipe(${i})">
                        <div class="meal-title">${r.name}</div>
                        <div class="meal-macros">${r.cal} kcal</div>
                    </div>
                `;
            });
            
            if(recipes.length === 0) list.innerHTML = "<p style='color:gray'>No recipes created yet.</p>";

            openDrawer('drawer-select');
        }

        function selectRecipe(idx) {
            schedule[currentSlot] = idx;
            localStorage.setItem('proSchedule', JSON.stringify(schedule));
            closeDrawer('drawer-select');
            renderTimeline();
            updateDashboard();
        }

        function clearSlot() {
            delete schedule[currentSlot];
            localStorage.setItem('proSchedule', JSON.stringify(schedule));
            closeDrawer('drawer-select');
            renderTimeline();
            updateDashboard();
        }

        // --- SHOPPING LIST ---
        function renderShopping() {
            const container = document.getElementById('shoppingListContainer');
            let totals = {};

            Object.values(schedule).forEach(idx => {
                const r = recipes[idx];
                if(r) {
                    r.ings.forEach(ing => {
                        const k = `${ing.n}|${ing.u}`;
                        totals[k] = (totals[k] || 0) + ing.q;
                    });
                }
            });

            container.innerHTML = "";
            if(Object.keys(totals).length === 0) container.innerHTML = "<p style='color:gray'>Plan some meals first.</p>";

            for(let [k, q] of Object.entries(totals)) {
                const [n, u] = k.split('|');
                container.innerHTML += `
                    <label class="check-item">
                        <input type="checkbox" onchange="this.parentElement.classList.toggle('done')">
                        <span style="flex:1">${n}</span>
                        <strong style="color:var(--accent)">${q} ${u}</strong>
                    </label>
                `;
            }
        }

        // --- DRAWER & UI UTILS ---
        function openDrawer(id) {
            const el = document.getElementById(id);
            el.style.display = 'flex';
            setTimeout(() => { el.querySelector('.drawer').classList.add('open'); }, 10);
        }

        function closeDrawer(id) {
            const el = document.getElementById(id);
            el.querySelector('.drawer').classList.remove('open');
            setTimeout(() => { el.style.display = 'none'; }, 300);
        }

        function openRecipeDrawer() {
            document.getElementById('ingContainer').innerHTML = "";
            document.getElementById('newRecName').value = "";
            document.getElementById('newRecCal').value = "";
            addIngInput();
            openDrawer('drawer-recipe');
        }

        function addIngInput() {
            const d = document.createElement('div');
            d.className = 'ing-row';
            d.innerHTML = `
                <input class="ing-n" placeholder="Item" style="flex:2">
                <input class="ing-q" type="number" placeholder="Qty" style="flex:1">
                <select class="ing-u">
                    <option>g</option><option>ml</option><option>oz</option><option>unit</option>
                </select>
            `;
            document.getElementById('ingContainer').appendChild(d);
        }

        function switchView(viewName, btn) {
            // Hide all
            document.getElementById('view-timeline').style.display = 'none';
            document.getElementById('view-shopping').style.display = 'none';
            document.getElementById('view-recipes').style.display = 'none';
            
            // Show target
            document.getElementById('view-'+viewName).style.display = 'block';

            // Update nav
            document.querySelectorAll('.dock-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if(viewName === 'shopping') renderShopping();
            if(viewName === 'recipes') renderRecipes();
        }

        init();
    </script>
</body>
</html>

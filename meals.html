<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Meal Prep | Dark Mode</title>
    <style>
        :root {
            --bg: #191919;
            --secondary: #202020;
            --border: #2f2f2f;
            --text: #ffffff;
            --text-dim: #a4a29e;
            --accent: #2383e2;
            --card-bg: #252525;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, sans-serif; 
            background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.5; 
        }
        
        h1 { font-size: 1.6rem; font-weight: 700; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        h2 { font-size: 1.1rem; color: var(--text-dim); margin-top: 30px; }

        .section { margin-bottom: 30px; }
        
        input, select { 
            width: 100%; padding: 10px; margin: 5px 0; border: 1px solid var(--border); 
            border-radius: 6px; background: var(--secondary); font-size: 14px; color: var(--text); 
        }
        
        button { 
            cursor: pointer; border-radius: 6px; padding: 10px 15px; font-size: 14px; 
            border: 1px solid var(--border); background: var(--card-bg); color: var(--text); 
        }
        .btn-primary { background: var(--accent); border: none; font-weight: 600; }

        /* Calendrier Style Sombre */
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .day-card { border: 1px solid var(--border); padding: 15px; border-radius: 8px; background: var(--card-bg); }
        .day-name { font-weight: 700; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
        
        .meal-slot { margin-bottom: 10px; }
        .meal-label { font-size: 11px; text-transform: uppercase; color: var(--text-dim); display: block; margin-bottom: 2px; }

        .recipe-list-item { 
            display: flex; justify-content: space-between; padding: 12px; 
            border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; background: var(--secondary);
        }

        .shopping-list { background: #2d2b1f; border-left: 4px solid #fbc02d; padding: 15px; border-radius: 8px; list-style: none; }
        .check-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .check-item input[type="checkbox"] { width: auto; scale: 1.2; }
        .done { text-decoration: line-through; opacity: 0.4; }
    </style>
</head>
<body>

    <nav style="font-size: 14px; color: var(--text-dim); margin-bottom: 20px;">
        <a href="index.html" style="color: inherit; text-decoration: none;">üè† Home</a> / üåë Meal Prep
    </nav>

    <h1>üåë Planning Hebdomadaire</h1>

    <div class="section">
        <div class="calendar-grid" id="calendar"></div>
        <button class="btn-primary" style="margin-top: 20px; width: 100%;" onclick="generateShoppingList()">üõí G√©n√©rer la liste de courses</button>
    </div>

    <div id="shoppingSection" class="section" style="display:none;">
        <h2>üõí Liste de Courses</h2>
        <div id="shoppingListContainer" class="shopping-list"></div>
    </div>

    <div class="section">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2>Mes Recettes</h2>
            <button onclick="openRecipeForm()">+ Ajouter</button>
        </div>
        <div id="recipeLibrary"></div>
    </div>

    <div id="recipeForm" class="section" style="display:none; border: 1px solid var(--accent); padding: 20px; border-radius: 12px; background: var(--secondary);">
        <h2 id="formTitle" style="color: var(--accent);">Nouvelle Recette</h2>
        <input type="hidden" id="editIndex">
        <input type="text" id="recName" placeholder="Nom du plat">
        <input type="number" id="recCal" placeholder="Calories (kcal)">
        <div id="ingRows"></div>
        <button onclick="addIngRow()" style="margin-top:10px; width: 100%;">+ Ajouter un ingr√©dient</button>
        <div style="margin-top: 20px; display: flex; gap: 10px;">
            <button class="btn-primary" style="flex: 2;" onclick="saveRecipe()">Enregistrer</button>
            <button onclick="closeRecipeForm()" style="flex: 1;">Annuler</button>
        </div>
    </div>

    <script>
        let recipes = JSON.parse(localStorage.getItem('notionRecipes')) || [];
        // Plan format: { "Lundi": { "matin": idx, "midi": idx, ... } }
        let plan = JSON.parse(localStorage.getItem('mealPlan')) || {};
        const days = ["Lundi", "Mardi", "Mercredi", "Jeudi", "Vendredi", "Samedi", "Dimanche"];
        const slots = ["Matin", "Midi", "Snack", "Soir"];

        function init() {
            renderCalendar();
            renderLibrary();
        }

        function renderCalendar() {
            const cal = document.getElementById('calendar');
            cal.innerHTML = "";
            days.forEach(day => {
                let slotHtml = "";
                slots.forEach(slot => {
                    const savedIdx = (plan[day] && plan[day][slot]) ? plan[day][slot] : "";
                    let options = recipes.map((r, i) => `<option value="${i}" ${savedIdx == i ? 'selected' : ''}>${r.name}</option>`).join('');
                    slotHtml += `
                        <div class="meal-slot">
                            <label class="meal-label">${slot}</label>
                            <select onchange="updatePlan('${day}', '${slot}', this.value)">
                                <option value="">-- Vide --</option>
                                ${options}
                            </select>
                        </div>
                    `;
                });

                cal.innerHTML += `
                    <div class="day-card">
                        <div class="day-name">${day}</div>
                        ${slotHtml}
                    </div>
                `;
            });
        }

        function updatePlan(day, slot, recipeIndex) {
            if (!plan[day]) plan[day] = {};
            if (recipeIndex === "") delete plan[day][slot];
            else plan[day][slot] = recipeIndex;
            localStorage.setItem('mealPlan', JSON.stringify(plan));
        }

        function renderLibrary() {
            const lib = document.getElementById('recipeLibrary');
            lib.innerHTML = recipes.length === 0 ? "<p style='color:var(--text-dim)'>Aucune recette enregistr√©e.</p>" : "";
            recipes.forEach((r, i) => {
                lib.innerHTML += `
                    <div class="recipe-list-item">
                        <span><strong>${r.name}</strong> <small style="color:var(--text-dim)">‚Ä¢ ${r.cal} kcal</small></span>
                        <div>
                            <button onclick="editRecipe(${i})">Edit</button>
                            <button onclick="deleteRecipe(${i})" style="border-color: #ff453a; color: #ff453a;">‚úï</button>
                        </div>
                    </div>
                `;
            });
        }

        function addIngRow(name="", qty="", unit="g") {
            const div = document.createElement('div');
            div.className = 'ing-row';
            div.innerHTML = `
                <input type="text" placeholder="Ingr√©dient" value="${name}" class="i-n" style="flex:2">
                <input type="number" placeholder="Qt√©" value="${qty}" class="i-q" style="flex:1">
                <select class="i-u" style="flex:1">
                    <option ${unit=='g'?'selected':''}>g</option>
                    <option ${unit=='ml'?'selected':''}>ml</option>
                    <option ${unit=='tsp'?'selected':''}>tsp</option>
                    <option ${unit=='tbsp'?'selected':''}>tbsp</option>
                    <option ${unit=='unit√©'?'selected':''}>unit√©</option>
                </select>
            `;
            document.getElementById('ingRows').appendChild(div);
        }

        function saveRecipe() {
            const idx = document.getElementById('editIndex').value;
            const name = document.getElementById('recName').value;
            const cal = document.getElementById('recCal').value;
            const rows = document.querySelectorAll('.ing-row');
            let ings = [];
            rows.forEach(r => {
                const n = r.querySelector('.i-n').value;
                const q = r.querySelector('.i-q').value;
                const u = r.querySelector('.i-u').value;
                if(n && q) ings.push({n, q: parseFloat(q), u});
            });

            if(!name) return alert("Nom requis");
            const data = {name, cal, ings};
            if(idx !== "") recipes[idx] = data;
            else recipes.push(data);

            localStorage.setItem('notionRecipes', JSON.stringify(recipes));
            location.reload();
        }

        function openRecipeForm() {
            document.getElementById('recipeForm').style.display = "block";
            document.getElementById('editIndex').value = "";
            document.getElementById('recName').value = "";
            document.getElementById('ingRows').innerHTML = "";
            addIngRow();
            window.scrollTo(0, document.getElementById('recipeForm').offsetTop);
        }

        function editRecipe(i) {
            openRecipeForm();
            document.getElementById('formTitle').innerText = "Modifier la recette";
            document.getElementById('editIndex').value = i;
            document.getElementById('recName').value = recipes[i].name;
            document.getElementById('recCal').value = recipes[i].cal;
            document.getElementById('ingRows').innerHTML = "";
            recipes[i].ings.forEach(ing => addIngRow(ing.n, ing.q, ing.u));
        }

        function deleteRecipe(i) {
            if(confirm("Supprimer cette recette ?")) {
                recipes.splice(i, 1);
                localStorage.setItem('notionRecipes', JSON.stringify(recipes));
                location.reload();
            }
        }

        function generateShoppingList() {
            let totals = {};
            Object.values(plan).forEach(daySlots => {
                Object.values(daySlots).forEach(idx => {
                    const rec = recipes[idx];
                    if(rec) {
                        rec.ings.forEach(ing => {
                            const key = `${ing.n}|${ing.u}`;
                            totals[key] = (totals[key] || 0) + ing.q;
                        });
                    }
                });
            });

            const container = document.getElementById('shoppingListContainer');
            container.innerHTML = "";
            if (Object.keys(totals).length === 0) container.innerHTML = "Aucun ingr√©dient √† acheter.";
            
            for (let [k, q] of Object.entries(totals)) {
                const [n, u] = k.split('|');
                container.innerHTML += `
                    <div class="check-item">
                        <input type="checkbox" onchange="this.parentElement.classList.toggle('done')">
                        <span>${n} : <strong>${q} ${u}</strong></span>
                    </div>
                `;
            }
            document.getElementById('shoppingSection').style.display = "block";
            window.scrollTo(0, document.getElementById('shoppingSection').offsetTop);
        }

        function closeRecipeForm() { document.getElementById('recipeForm').style.display = "none"; }

        init();
    </script>
</body>
</html>
